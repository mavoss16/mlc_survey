---
title: "Memorial Lutheran Church Survey"
format: 
  html:
    page-layout: custom
    echo: false
    warning: false
    message: false
---

```{r}
library(readr)

library(dplyr)
library(stringr)
# library(forcats)
library(plotly)

library(crosstalk)
# library(DT)
library(htmltools)
library(bslib)
library(reactable)


bs_theme_dependencies(bs_theme(preset = "bootstrap")) |>
  lapply(function(x) {
    if (x$name == "bootstrap") {
      x$name <- "bootstrap-from-bslib"
    }
    x
  }) |>
  htmltools::tagList()

```

```{css}
.sidebar-content {
  padding-top: 0rem !important;
  gap: 0.1rem !important;
}

.tab-pane {
  overflow-x: auto;
}

.bslib-grid {
  max-width: 100%;
}

.html-fill-container {
  overflow-x: hidden;
}

.reactable {
  height: 600px;
  overflow: auto;
}

.rt-thead {
  position: sticky !important;
  top: 0 !important;
  background: white !important;
  z-index: 10 !important;
}

```


```{r}

wide <- read_rds("survey_clean.rds")
long <- read_rds("survey_multi_long.rds")
table_data <- read_rds("table_data.rds")

shared_wide <- SharedData$new(wide, key = ~response_id)
shared_long <- SharedData$new(wide, key = ~response_id, group = "long_survey")

# Make sure long has the same id column (linked to wide)
# If long is derived from wide, carry over the id
church_exp_data <- long |> filter(question == "church_expectations_choice")
connection_data <- long |> filter(question == "connection_factors_choice")
music_data <- long |> filter(question == "music_styles_choice")
church_pri_data <- long |> filter(question == "church_priorities_choice")

# Use the same group name "survey"
shared_church_exp <- SharedData$new(church_exp_data, key = ~response_id, group = "long_survey")
shared_connection <- SharedData$new(connection_data, key = ~response_id, group = "long_survey")
shared_music <- SharedData$new(music_data, key = ~response_id, group = "long_survey")
shared_church_pri <- SharedData$new(church_pri_data, key = ~response_id, group = "long_survey")

```

```{r}

# Get all unique responses for this question
church_exp_categories <- long |> 
  filter(question == "church_expectations_choice") |> 
  pull(response) |> 
  unique()

# Get all unique responses for this question
connection_categories <- long |>
  filter(question == "connection_factors_choice") |>
  pull(response) |>
  unique()

# Get all unique responses for this question
music_categories <- long |>
  filter(question == "music_styles_choice") |>
  pull(response) |>
  unique()

# Get all unique responses for this question
church_pri_categories <- long |>
  filter(question == "church_priorities_choice") |>
  pull(response) |>
  unique()

title_wrap <- function(str, line_br = "<br>", ...){
  str_wrap(str, ...) |>
    str_replace_all(pattern = "\\n", replacement = line_br)
}

truncate_cell <- function(max_chars = 50) {
  function(value) {
    if (is.na(value) || nchar(value) <= max_chars) return(value)
    
    div(
      title = value,
      style = "cursor: help; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;",
      value
    )
  }
}

tags$script(HTML("
  document.addEventListener('DOMContentLoaded', function() {
    tippy('.tooltip-cell', {
      content: (reference) => reference.getAttribute('data-tooltip'),
      allowHTML: true,
      interactive: true,
      maxWidth: 500
    });
  });
"))

```


```{r}
inline_count <- function(shared_data, id = NULL, unique_by = NULL, 
                         filter_col = NULL, filter_not_na = FALSE) {
  if (is.null(id)) {
    id <- paste0("count_", sample.int(10000, 1))
  }
  
  data <- shared_data$data()
  
  # Apply initial filtering if specified
  if (!is.null(filter_col)) {
    if (filter_not_na) {
      data <- data[!is.na(data[[filter_col]]), ]
    }
  }
  
  # Calculate initial count
  if (!is.null(unique_by)) {
    total <- length(unique(data[[unique_by]]))
  } else {
    total <- nrow(data)
  }
  
  # Create the counter span
  counter_span <- tags$span(
    id = id, 
    class = "crosstalk-count", 
    style = "font-weight: bold; color: #0066cc; display: inline;",
    as.character(total)
  )
  
  # Build data storage for JavaScript
  if (!is.null(filter_col) || !is.null(unique_by)) {
    # Need to store data for filtering/unique counting
    cols_needed <- unique(c(filter_col, unique_by))
    data_subset <- shared_data$data()[cols_needed]
    data_list <- lapply(seq_len(nrow(shared_data$data())), function(i) {
      row_data <- lapply(data_subset[i, , drop = FALSE], function(x) x)
      names(row_data) <- cols_needed
      row_data
    })
    names(data_list) <- shared_data$key()
    data_json <- jsonlite::toJSON(data_list, auto_unbox = TRUE, na = "null")
  } else {
    data_json <- "{}"
  }
  
  # Build JavaScript for filtering
  filter_js <- if (!is.null(filter_col) && filter_not_na) {
    sprintf('
      // Filter out rows where filter_col is NA
      filteredKeys = filteredKeys.filter(function(key) {
        var rowData = allData[key];
        return rowData && rowData["%s"] !== null && rowData["%s"] !== undefined;
      });
    ', filter_col, filter_col)
  } else {
    ''
  }
  
  # Build JavaScript for unique counting
  unique_js <- if (!is.null(unique_by)) {
    sprintf('
      // Get unique values from the column
      var uniqueVals = new Set();
      filteredKeys.forEach(function(key) {
        var rowData = allData[key];
        if (rowData && rowData["%s"] !== null && rowData["%s"] !== undefined) {
          uniqueVals.add(rowData["%s"]);
        }
      });
      count = uniqueVals.size;
    ', unique_by, unique_by, unique_by)
  } else {
    'count = filteredKeys.length;'
  }
  
  update_script <- tags$script(HTML(sprintf('
    (function() {
      var shared = crosstalk.group("%s");
      var keysVar = shared.var("keys");
      var filterVar = shared.var("filter");
      var counter = document.getElementById("%s");
      
      // Store all data with keys
      var allData = %s;
      
      function updateCount() {
        var keys = keysVar.get();
        var filter = filterVar.get();
        var count;
        
        // Determine which keys are currently visible
        var filteredKeys;
        if (filter && filter.length > 0) {
          filteredKeys = filter;
        } else if (keys && keys.length > 0) {
          filteredKeys = keys;
        } else {
          count = %d;
          counter.textContent = count;
          return;
        }
        
        %s
        
        %s
        
        counter.textContent = count;
      }
      
      keysVar.on("change", updateCount);
      filterVar.on("change", updateCount);
    })();
  ', 
  shared_data$groupName(), 
  id,
  data_json,
  total,
  filter_js,
  unique_js)), type = "text/javascript")
  
  # Wrap in a container to prevent line breaks
  tagList(
    tags$span(style = "display: inline;", counter_span),
    update_script
  )
}


inline_count_text <- function(...) {
  htmltools::tagList(inline_count(...))
}
```



```{r}
navset_bar(
  selected = "Respondent Overview",
  navbar_options = navbar_options(
    bg = "lightblue"
  ),
  nav_panel(
    title = "Respondent Overview",
    layout_columns(
      col_widths = c(4, 4, 4),
      plot_ly(wide, x = ~age_range, type = "histogram") |>
        layout(
            xaxis = list(tickangle = 45, title = "Age Range" |> title_wrap(width = 25)),
            yaxis = list(title = "Count")
          ) |>
          config(
            staticPlot = TRUE
          ),
      plot_ly(wide, x = ~service_attendance, type = "histogram") |>
        layout(
            xaxis = list(tickangle = 45, title = "Primary Service" |> title_wrap(width = 25)),
            yaxis = list(title = "Count")
          ) |>
          config(
            staticPlot = TRUE
          ),
      plot_ly(wide, x = ~church_association_length, type = "histogram") |>
        layout(
            xaxis = list(tickangle = 45, title = "Church Association Length" |> title_wrap(width = 25)),
            yaxis = list(title = "Count")
          ) |>
          config(
            staticPlot = TRUE
          )
    )
  ),
  nav_panel(
    title = "Single Choice",
    layout_sidebar(
      sidebar = sidebar(
        filter_checkbox("age", tags$strong("Age"), shared_wide, ~age_range),
        filter_checkbox("service", tags$strong("Primary Service"), shared_wide, ~service_attendance),
        filter_checkbox("association", tags$strong("Church Association Length"), shared_wide, ~church_association_length)
      ),
      
      tags$p("Number of Respondents (Filtered): ", inline_count_text(shared_wide)),
      layout_column_wrap(
        plot_ly(shared_wide, x = ~church_mission_feeling, type = "histogram") |>
          layout(
            xaxis = list(tickangle = 45, title = "How do you feel about MLC's mission?" |> title_wrap(width = 25)),
            yaxis = list(title = "Count")
          ) |>
          config(
            staticPlot = TRUE
          ),
        plot_ly(shared_wide, x = ~spiritually_fed, type = "histogram") %>%
          layout(
            xaxis = list(tickangle = 45, title = "Do you feel spiritually fed?" |> title_wrap(width = 25)),
            yaxis = list(title = "Count")
          ) |>
          config(
            staticPlot = TRUE
          ),
        plot_ly(shared_wide, x = ~connected_to_community, type = "histogram") %>%
          layout(
            xaxis = list(tickangle = 45, title = "Do you feel connected to the MLC community?" |> title_wrap(width = 25)),
            yaxis = list(title = "Count")
          ) |>
          config(
            staticPlot = TRUE
          )
      )
    )
  ),
  nav_panel(
    title = "Multi Choice",
    layout_sidebar(
      sidebar = sidebar(
        filter_checkbox("age", tags$strong("Age"), shared_long, ~age_range),
        filter_checkbox("service", tags$strong("Primary Service"), shared_long, ~service_attendance),
        filter_checkbox("association", tags$strong("Church Association Length"), shared_long, ~church_association_length)
      ),
      tags$p("Number of Respondents (Filtered): ", inline_count_text(shared_long, unique_by = "response_id")),
      navset_tab(
        selected = "Church Expectations",
        nav_panel(
          "Church Expectations",
          plot_ly(shared_church_exp, 
                  x = ~response, 
                  type = "histogram") %>%
            layout(
              xaxis = list(
                tickangle = 45, 
                title = "What do you look forward to most at MLC?" |> title_wrap(width = 25),
                categoryorder = "array",
                categoryarray = church_exp_categories
              ),
              yaxis = list(title = "Count")
            ) |>
            config(
              staticPlot = TRUE
            )
        ),
        nav_panel(
          "Connection Factors",
          plot_ly(shared_connection,
                  x = ~response,
                  type = "histogram") %>%
            layout(
              xaxis = list(
                tickangle = 45,
                title = "What things make you feel a connection to others at MLC?" |> title_wrap(width = 25),
                categoryorder = "array",
                categoryarray = connection_categories
              ),
              yaxis = list(title = "Count")
            ) |>
            config(
              staticPlot = TRUE
            )
        ),
        nav_panel(
          "Music Styles",
          plot_ly(shared_music,
                  x = ~response,
                  type = "histogram") %>%
            layout(
              xaxis = list(
                tickangle = 45,
                title = "What styles of music do you feel most connected to during worship?" |> title_wrap(width = 25),
                categoryorder = "array",
                categoryarray = music_categories
              ),
              yaxis = list(title = "Count")
            ) |>
            config(
              staticPlot = TRUE
            )
        ),
        nav_panel(
          "Church Priorities",
          plot_ly(shared_church_pri,
                  x = ~response,
                  type = "histogram") %>%
            layout(
              xaxis = list(
                tickangle = 45,
                title = "What aspects of our church would you like to see prioritized in the next 3-5 years?" |> title_wrap(width = 25),
                categoryorder = "array",
                categoryarray = church_pri_categories
              ),
              yaxis = list(title = "Count")
            ) |>
            config(
              staticPlot = TRUE
            )
        )
      )
    )
  ),
  nav_panel(
    title = "Full Data",
    reactable(
      table_data |> select(-response_id),
      height = "700px",
      highlight = TRUE, striped = TRUE,
      searchable = TRUE, filterable = TRUE, resizable = TRUE, showPageSizeOptions = TRUE, defaultPageSize = 25,
      defaultColDef = colDef(
        minWidth = 115,
        headerStyle = list(position = "sticky", top = 0, background = "#fff", zIndex = 1),
        cell = function(value) {
          # print(value)
          if (length(value) == 0){
            return(value)
          } else if(class(value) != "character"){
            return(value)
          } else if(is.na(value) | nchar(value) <= 50) {
            return(value)
          }
          # if (is.null(value) | is.na(value) | nchar(value) <= 50) return(value)
          
          htmltools::div(
            class = "tooltip-cell",
            `data-tooltip` = value,
            style = "text-decoration: underline dotted; cursor: help;",
            paste0(substr(value, 1, 50), "...")
          )
        },
        html = TRUE
      )
    )
  )
)

```

```{r}
#| echo: false
tags$script(HTML("
  window.addEventListener('load', function() {
    setTimeout(function() {
      // Handle main tabs
      var firstTabPane = document.querySelector('.tab-pane[data-value=\"Respondent Overview\"]');
      if (firstTabPane) {
        document.querySelectorAll('.tab-pane').forEach(function(pane) {
          pane.classList.remove('active', 'show');
        });
        firstTabPane.classList.add('active', 'show');
      }
      
      var correctLink = document.querySelector('a[data-value=\"Respondent Overview\"]');
      if (correctLink) {
        document.querySelectorAll('.navbar-nav a').forEach(function(link) {
          link.classList.remove('active');
        });
        correctLink.classList.add('active');
      }
      
      // Click the Church Expectations tab to initialize it
      var churchExpLink = document.querySelector('a[data-value=\"Church Expectations\"]');
      if (churchExpLink) {
        churchExpLink.click();
      }
      
      window.dispatchEvent(new Event('resize'));
    }, 100);
  });
"))
```

